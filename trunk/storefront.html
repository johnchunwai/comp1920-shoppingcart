<html>
<head>
<script type="text/javascript" src="./scripts/jquery-1.7.min.js"></script>
<script type="text/javascript" src="./scripts/common.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		
		ajaxSetup();
		
		// Check whether the user already logged in and redirect to login page if not.
		$.getJSON("./login.php?method=getLoginInfo", function(resp) {
			if (!resp.login) {
				window.location = "login.html";
			}
			else {
				$(".user_id").html(resp.user_id);
			}
		});
		
		// Present the product catalog for purchase.
		$.getJSON('./storefront.php?method=getProducts', function(resp) {
			// Present the catalog as a table.
			catalog = '<table>';
			$.each(resp, function(id, details) {
				catalog += '<tr>';
				catalog += '<td><img src="' + details.prod_image + '"/></td>';
				catalog += '<td>' + details.prod_name + '</td>';
				catalog += '<td>' + details.prod_desc + '</td>';
				catalog += '<td>' + createSelectForQuantity(id + '_qty', 1, 10) + '</td>';
				catalog += '<td><input type="button" class="button" id="' + id + '" value="Add to Cart"/></td>';
				catalog += '</tr>';
			});
			catalog += '</table>';
			$("#product_div").html(catalog);

			// Hook up add items to cart action when user clicks the buttons.
			$("#product_div input.button").click(function() {
				$.getJSON("./cart.php?method=addToCart",
				{
					prod_id: this.id,
					count: $("#product_div select#" + this.id + "_qty").val()
				},
				function(resp) {
					if (resp.succeed) {
						$("#msg").html('Item added to cart.');
					}
					else {
						$("#msg").html('Failed to add item to cart: ' + resp.msg);
					}
				});
			});
		});
	});
</script>
</head>
<body>
	<h1>Store</h1>
	<p>Welcome <span class="user_id"></span> to our store. (<a href="./logout.html">If you're not <span class="user_id"></span>, click here to logout</a>)</p>
	<h2>Products</h2>
	<div id="product_div"></div>
	<div id="msg"></div>
	<form action="./checkout.html">
		<input type="submit" value="Proceed to Checkout"/>
	</form>
</body>
</html>